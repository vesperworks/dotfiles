# 調査結果レポート - Hooks実行エラー問題

## 📋 要約
現在のhooksセットアップはシンボリックリンクを使用していないが、ディレクトリ構造に問題があり、hooks実行時にパスが正しく解決されずエラーが発生している。コピー方式への移行により、より安定した実行環境を構築できる。

## 🔍 詳細分析

### 現状

1. **ディレクトリ構造の問題**
   - `~/.claude/hooks/hooks/` という二重ネスト構造になっている
   - 実際のhookスクリプトは `~/.claude/hooks/hooks/*.sh` に存在
   - settings.jsonは `~/.claude/hooks/*.sh` を参照しているため、パスが一致しない

2. **シンボリックリンクの状況**
   - `setup-links.sh` スクリプトは `commands`, `prompts`, `scripts`, `templates` のみをシンボリックリンク化
   - `hooks` ディレクトリはシンボリックリンクの対象外

3. **現在のhookファイル**
   - プロジェクト内: `.claude/hooks/textlint-hook.sh`, `.claude/hooks/stop-send-notification.sh`
   - ホームディレクトリ: `~/.claude/hooks/hooks/` 内に同じファイル
   - 追加ファイル: `~/.claude/hooks/stop-send-notification.js` (JavaScript版)

### 発見した問題

1. **パス不整合**
   - settings.jsonの参照パスと実際のファイルパスが異なる
   - 二重ネスト構造により、Claudeがhookスクリプトを見つけられない

2. **実行権限の懸念**
   - シンボリックリンク経由での実行は、セキュリティ制限により失敗する可能性
   - Claudeの実行環境では直接アクセスが推奨される

3. **管理の複雑さ**
   - 現在の構造では、どのファイルが実際に使用されているか不明確
   - 開発時と実行時でパスが異なる可能性

### 提案する解決策

1. **コピー方式への移行**
   ```bash
   # hookファイルを直接コピー
   cp .claude/hooks/*.sh ~/.claude/hooks/
   # 実行権限を付与
   chmod +x ~/.claude/hooks/*.sh
   ```

2. **セットアップスクリプトの作成**
   - `setup-hooks.sh`: hooksを適切な場所にコピーし、権限を設定
   - `update-hooks.sh`: 開発中のhooksを更新
   - `cleanup-hooks.sh`: 不要なhooksを削除

3. **ディレクトリ構造の修正**
   - 二重ネスト構造を解消
   - プロジェクト内のhooksを明確に管理

## 📊 影響評価
- 作業量: 小
- リスク: 低
- 優先度: 高

## 🎯 推奨アクション

1. **ディレクトリ構造の調査と修正**
   - 現在の二重ネスト構造を解消
   - 正しいパスでhooksを配置

2. **コピー方式のセットアップスクリプト作成**
   - `setup-hooks.sh`: 初期セットアップ用
   - `update-hooks.sh`: 開発時の更新用
   - 実行権限の自動設定を含む

3. **既存のセットアップスクリプトとの統合**
   - `setup-links.sh` にhooksのコピー処理を追加
   - または独立したhooks管理スクリプトとして実装

4. **ドキュメントの更新**
   - README.mdにhooksのセットアップ方法を記載
   - 開発ワークフローの説明を追加

---
次のアクションを選択してください：
1️⃣ `/p add-todo` - todo.mdに追加
2️⃣ `/p execute` - すぐに実行