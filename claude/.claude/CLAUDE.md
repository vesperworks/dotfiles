# 最重要ルール - 新しいルールの追加プロセス

ユーザーから今回限りではなく常に対応が必要だと思われる指示を受けた場合：

1. 「これを標準のルールにしますか？」と質問する
2. YESの回答を得た場合、CLAUDE.mdに追加ルールとして記載する
3. 以降は標準ルールとして常に適用する

このプロセスにより、プロジェクトのルールを継続的に改善していきます。

## 提案時のルール

提案を求められた時は、推奨確率を添えて最低3パターン提案してください。

## コーディング原則
- YAGNI（You Aren't Gonna Need It）：今必要じゃない機能は作らない
- DRY（Don't Repeat Yourself）：同じコードを繰り返さない
- KISS（Keep It Simple Stupid）：シンプルに保つ
- SOLID：オブジェクト指向設計の5原則を守る（単一責任・オープン/クローズド・リスコフの置換・インターフェース分離・依存性逆転）


## 推奨コマンド
- rg
- ni
- nr 

NEVER: Path Traversal
NEVER: Command Injection
NEVER: XSS (Cross-Site Scripting)

## 基本原則                                                                                                         
- Explore -> Plan -> Confirm -> Code -> Commit
- **推論の制限**: 記載されていない内容や不明な点について推測せず、必ずユーザーに確認する
- **エスカレーション**: 3回連続で問題に行き詰まった場合は、ユーザーに指示を仰ぐ
- **対話言語**: 日本語でコミュニケーションを行う
- 現在の作業が明確でない場合は、どんなアプリを作りたいのか、要件定義を僕にヒアリングをしてください。

## 技術実装の方針                                                                                                   
 **公式ドキュメント優先**: ライブラリやフレームワークを使用する際は、最新の公式ドキュメントを必ず参照する
 **設計思想の理解**: 使用する技術の設計思想を理解し、その作法に従って実装を提案する
 **既存コードとの整合性**: プロジェクト内の既存のコーディング規約やパターンに従う
 
## 開発ワークフロー

### 推奨フロー

#### パターンA: PRP統合ワークフロー（仕様が不明確な場合）
1. `/contexteng-gen-prp "feature-name"` - 対話的に仕様を決定
2. `/contexteng-exe-prp` - TDD実装→検証ループ
3. `/sc` - スマートコミット

#### パターンB: 直接実装ワークフロー（仕様が明確な場合）
1. `@vw-task-manager` - プロジェクト状況確認
2. 直接実装（Main Claude）→ `@vw-dev-reviewer` + `@vw-dev-tester` で検証
3. `/sc` - スマートコミット

## vw-* エージェント起動ルール

ユーザーが以下の要求をした場合、適切なエージェントを**必ず**使用してください。

### vw-dev-orchestra（PRP実行オーケストレーター）
以下のいずれかの場合、**必ず** `vw-dev-orchestra`（subagent_type='vw-dev-orchestra'）を使用：
- PRPを使った実装（例: 「PRPを使って実装」「PRP/feature.mdで実装」）
- TDD実装→検証ループ（例: 「TDDで開発」「テスト駆動で実装」）
- 複数コンポーネント開発（例: 「全体の実装」「システム全体」）

Main Claudeが直接TDD実装を行い、vw-dev-reviewer + vw-dev-tester で検証。

### vw-prp-orchestrator（PRP生成統括）
以下のいずれかの場合、**必ず** `vw-prp-orchestrator`（subagent_type='vw-prp-orchestrator'）を使用：
- PRP生成（例: 「PRP作って」「PRP生成」「PRPを書いて」）
- 複数案での設計比較（例: 「複数案で」「4パターンで」「比較検討して」「マルチモード」「じっくり考えて」）
- 設計アプローチ選択（例: 「どの設計がいい？」「設計案を比較」）

/contexteng-gen-prp コマンドはこのエージェントを内部で呼び出します。

### vw-dev-tester（E2Eテスト）
以下のいずれかの場合、**必ず** `vw-dev-tester`（subagent_type='vw-dev-tester'）を使用：
- ブラウザテスト（例: 「ブラウザでテスト」「E2Eテスト」「Playwrightでテスト」）
- 実装完了後の検証（例: 「実装が完了したので検証」「本番前の最終確認」）

Playwright MCPを使用したE2Eテストを実行。

### vw-dev-reviewer（静的解析・品質ゲート）
以下のいずれかの場合、**必ず** `vw-dev-reviewer`（subagent_type='vw-dev-reviewer'）を使用：
- コードレビュー（例: 「レビューして」「品質確認」「Lintチェック」）
- 品質ゲート実行（例: 「Lint/Format/Test/Build」「品質チェック」）

Lint→Format→Test→Build の品質ゲートを順序実行。

### vw-task-manager（プロジェクト進捗管理）
以下のいずれかの場合、**必ず** `vw-task-manager`（subagent_type='vw-task-manager'）を使用：
- 進捗確認（例: 「進捗を確認」「プロジェクトの状況」「どこまで進んでる？」）
- 次のタスク確認（例: 「次は何をすべき？」「what's next」「次のタスク」）
- PRP整理（例: 「PRPを整理」「完了したPRPを移動」）

プロジェクト開始時・区切りの良いタイミングで自動的に起動を検討すること。

## Gemini Search
`gemini` は google gemini cliです。あなたはWeb検索でこのツールを使えます。
Run web search via Task Tool with `gemini -p 'WebSearch: ...'`.
'echo ...で検索中'も一緒に実行してください。

## commit規則
- authorを2度と書くな。setting.jsonにも書いてある。

### 📝 コードレビュー基準

## 可読性・保守性
- **変数名**: 目的が明確にわかること（`data`ではなく`userProfiles`）
- **関数の責任**: 1つの関数は1つの責任のみを持つ
- **ネスト制限**: ネストは3レベル以下に抑える
- **コメント**: 「なぜ」を説明する（「何を」ではなく）

## セキュリティ
- **入力検証**: ユーザー入力は必ずサニタイズ・バリデーション
- **SQLインジェクション対策**: パラメータ化クエリ使用
- **機密情報管理**: 環境変数で管理、ログに出力禁止
- **禁止事項**: eval()使用禁止、パスワードハードコーディング禁止

## パフォーマンス
- **データベース**: N+1クエリの発生チェック
- **メモリ管理**: イベントリスナーの適切な削除
- **大量データ**: ページネーションの実装

## エラーハンドリング
- **API呼び出し**: すべてのAPI呼び出しでエラーハンドリング実装
- **ユーザー体験**: ユーザーフレンドリーなエラーメッセージ
- **ログ管理**: 適切なログレベル設定（ERROR, WARN, INFO）

## レビュー優先度
- **CRITICAL**: セキュリティ、データ損失リスク
- **HIGH**: パフォーマンス、保守性
- **MEDIUM**: 可読性、一貫性
- **LOW**: スタイル、コメント

## ドキュメント管理ルール

### ファイルの役割分担
- **CLAUDE.md**: プロジェクト指南書（未来志向、技術スタック・規約・ワークフロー）
- **LOG.md**: 作業履歴（完了タスク・削除記録・移行履歴）
- **PRPs/**: プロジェクト要件計画（実装前・実装中の要件定義）

### 記録ルール
- **作業完了**: LOG.md に記録（「〇〇を完了しました」）
- **調査結果**: CLAUDE.md に反映（公式推奨やベストプラクティス）

### PRPs管理ルール
PRPファイルは完了後、以下のいずれかに移動：
- **PRPs/done/**: 実装完了・テスト通過・マージ済み
- **PRPs/cancel/**: 要件変更・不要・他PRPに置換
- **PRPs/tbd/**: 要件不明確・意思決定待ち・将来検討
