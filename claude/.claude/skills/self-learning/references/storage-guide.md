# Storage Guide

ルールの最適な保存先を判定するためのガイド。

## Overview

Claude Code のルール保存先は5種類あり、それぞれ適用範囲と用途が異なる。このガイドでは、決定木を使って最適な保存先を判定し、各保存先の特徴と追記方法を解説する。

## 保存先の決定木

```
Q1: このルールは、このプロジェクト固有か？
│
├─ NO (すべてのプロジェクトで適用)
│   │
│   └─ Q1a: カテゴリ別に整理したいか？
│       │
│       ├─ YES → ~/.claude/rules/{category}.md
│       │        (例: security-rules.md, coding-conventions.md)
│       │
│       └─ NO  → ~/.claude/CLAUDE.md
│                (グローバルルールの中心ファイル)
│
└─ YES (このプロジェクトのみ)
    │
    └─ Q2: 特定のファイルパターンに限定されるか？
        │
        ├─ YES → ./.claude/rules/{topic}.md
        │        (YAML frontmatter で paths: を指定)
        │
        └─ NO (プロジェクト全体に適用)
            │
            └─ Q3: チームで共有すべきか？
                │
                ├─ YES → ./CLAUDE.md または ./.claude/rules/*.md
                │        (Git管理対象)
                │
                └─ NO  → ./CLAUDE.local.md
                         (Git除外、個人設定)
```

## 各保存先の特徴

### 1. `~/.claude/CLAUDE.md` (グローバル)

| 項目 | 値 |
|------|-----|
| **適用範囲** | すべてのプロジェクト |
| **Git管理** | 対象外（個人設定） |
| **用途** | 個人の基本ルール、言語設定、思考プロセス指示 |

**適したルール例**:
- 「日本語で回答する」
- 「推論は日本語で行う」
- 「提案時は3パターン提示」

**追記場所**:
```markdown
# グローバルルール
## 基本原則
<!-- ここに追記 -->
```

---

### 2. `~/.claude/rules/*.md` (グローバル・カテゴリ別)

| 項目 | 値 |
|------|-----|
| **適用範囲** | すべてのプロジェクト |
| **Git管理** | 対象外（個人設定） |
| **用途** | カテゴリ別のルール整理（セキュリティ、品質基準等） |

**既存ファイル例**:
- `security-rules.md` - セキュリティ関連
- `quality-standards.md` - 品質基準
- `coding-conventions.md` - コーディング規約
- `lang-typescript.md` - TypeScript固有ルール

**追記方法**:
既存ファイルの適切なセクションに Edit で追加、または新規ファイルを作成。

---

### 3. `./CLAUDE.md` (プロジェクト共有)

| 項目 | 値 |
|------|-----|
| **適用範囲** | このプロジェクトのみ |
| **Git管理** | 対象（チーム共有） |
| **用途** | プロジェクト固有のルール、アーキテクチャ決定 |

**適したルール例**:
- 「このプロジェクトでは Biome を使用」
- 「API エンドポイントは /api/v1/ 配下」
- 「テストは Vitest で書く」

**追記場所**:
```markdown
## プロジェクト固有ルール
<!-- ここに追記 -->
```

---

### 4. `./.claude/rules/*.md` (プロジェクト・スコープ付き)

| 項目 | 値 |
|------|-----|
| **適用範囲** | このプロジェクトの特定ファイル |
| **Git管理** | 対象（チーム共有） |
| **用途** | 特定ディレクトリ・ファイルタイプへのルール |

**YAML frontmatter 形式**:
```yaml
---
paths:
  - "src/components/**/*.tsx"
  - "src/hooks/**/*.ts"
---

# React コンポーネントルール

- Prefer functional components over class components
- Always use TypeScript strict mode
```

**paths パターン例**:
| パターン | 適用対象 |
|---------|---------|
| `src/**/*.ts` | src配下のすべてのTypeScriptファイル |
| `*.md` | ルート直下のMarkdownファイル |
| `tests/**/*` | testsディレクトリ内のすべてのファイル |
| `**/api/**` | apiディレクトリを含むすべてのパス |

---

### 5. `./CLAUDE.local.md` (個人・ローカル)

| 項目 | 値 |
|------|-----|
| **適用範囲** | このプロジェクト（個人のみ） |
| **Git管理** | 対象外（.gitignore推奨） |
| **用途** | 個人的な作業メモ、一時的なルール |

**適したルール例**:
- 「現在作業中の機能: ユーザー認証」
- 「デバッグ用のログ出力を許可」
- 「自分用のショートカット設定」

---

## 保存先判定のフローチャート

```
ルール: "コミットメッセージにCo-Authored-Byを含めない"

Q1: プロジェクト固有か？
→ NO（すべてのプロジェクトで適用したい）

Q1a: カテゴリ別に整理？
→ YES（Git操作関連）

結果: ~/.claude/rules/coding-conventions.md
      または新規 ~/.claude/rules/git-rules.md
```

```
ルール: "このプロジェクトでは pnpm を使用"

Q1: プロジェクト固有か？
→ YES

Q2: 特定ファイルパターンに限定？
→ NO（プロジェクト全体）

Q3: チームで共有？
→ YES（全員が知るべき）

結果: ./CLAUDE.md
```

```
ルール: "Reactコンポーネントは必ずmemo化する"

Q1: プロジェクト固有か？
→ YES

Q2: 特定ファイルパターンに限定？
→ YES（*.tsx のみ）

結果: ./.claude/rules/react-components.md
      (paths: ["src/components/**/*.tsx"])
```

## 既存ルールファイルへの追記ガイドライン

### 1. 適切なセクションの特定

**Before**:
```markdown
## セキュリティルール

### 禁止事項
- eval()使用禁止
- パスワードハードコーディング禁止
```

**After** (新ルール追加):
```markdown
## セキュリティルール

### 禁止事項
- eval()使用禁止
- パスワードハードコーディング禁止
- innerHTML での動的HTML挿入禁止  <!-- 新規追加 -->
```

### 2. Markdown構造の保持

- 見出しレベルを既存と揃える
- リスト形式（`-` or `*`）を既存と揃える
- 空行の使い方を既存と揃える

### 3. Edit ツールでの追記

```markdown
Edit:
  file_path: "./CLAUDE.md"
  old_string: "- パスワードハードコーディング禁止"
  new_string: "- パスワードハードコーディング禁止\n- innerHTML での動的HTML挿入禁止"
```

### 4. 新規ファイル作成時のテンプレート

**グローバルルール (`~/.claude/rules/{category}.md`)**:
```markdown
# {Category} Rules

## Overview

{このカテゴリのルールの概要}

## Rules

- {ルール1}
- {ルール2}

## Examples

{必要に応じてコード例}
```

**スコープ付きルール (`./.claude/rules/{topic}.md`)**:
```yaml
---
paths:
  - "{glob pattern}"
---

# {Topic} Rules

{ルール内容}
```

## 保存完了後の確認

保存後、以下を確認:

1. **ファイル存在確認**: `ls -la {file_path}`
2. **内容確認**: `Read {file_path}`
3. **構文確認**: Markdown の見出しレベル、リスト形式が崩れていないか
4. **Git状態確認**: `git status` で意図したファイルが変更されているか

## Best Practices

- **グローバル vs プロジェクト**: 迷ったらプロジェクト固有（./CLAUDE.md）から始める
- **カテゴリ分類**: 5個以上のルールが同一カテゴリにあれば、専用ファイルを検討
- **paths の粒度**: 広すぎると意図しないファイルに適用、狭すぎると管理が煩雑
- **定期的な整理**: 古いルールの削除、重複の統合を定期的に実施

## Common Pitfalls

- **CLAUDE.md 肥大化**: ルールを追加し続けると読み込み時間が増加。カテゴリ別に分割を検討
- **paths の typo**: glob パターンのタイポで適用されない。実際のファイルパスで検証
- **矛盾するルール**: グローバルとプロジェクトで矛盾するルールがあると予測不能な動作に
- **local.md の共有**: CLAUDE.local.md を誤ってコミットしないよう .gitignore を確認
