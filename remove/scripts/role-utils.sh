#!/bin/bash
# role-utils.sh - å½¹å‰²é€²åŒ–å‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
# 
# ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ worktree ã‚’ä½¿ã‚ãªã„ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
# ã™ã¹ã¦ã®ä¸­é–“æˆæœç‰©ã¯ ./tmp/ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚

set -euo pipefail

# ã‚«ãƒ©ãƒ¼å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# ãƒ­ã‚°é–¢æ•°
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1" >&2; }
log_role() { echo -e "${MAGENTA}[ROLE]${NC} $1"; }

# ç¾åœ¨ã®å½¹å‰²ã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°
CURRENT_ROLE=""

# tmpãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ç¢ºä¿
ensure_tmp_dir() {
    if [[ ! -d "./tmp" ]]; then
        mkdir -p ./tmp
        log_success "Created ./tmp directory"
    fi
}

# å½¹å‰²ã®åˆ‡ã‚Šæ›¿ãˆ
switch_role() {
    local new_role="$1"
    local description="${2:-}"
    
    CURRENT_ROLE="$new_role"
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    log_role "ğŸ­ Switching to $new_role mode"
    if [[ -n "$description" ]]; then
        echo -e "${CYAN}$description${NC}"
    fi
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
}

# æˆæœç‰©ã®ä¿å­˜ï¼ˆ./tmp/ã«çµ±ä¸€ï¼‰
save_artifact() {
    local role="$1"
    local content="$2"
    local timestamp=$(date +%Y%m%d-%H%M%S)
    local role_lower=$(echo "$role" | tr '[:upper:]' '[:lower:]')
    local filepath="./tmp/${timestamp}-${role_lower}-report.md"
    
    ensure_tmp_dir
    
    # å†…å®¹ã‚’ä¿å­˜
    echo "$content" > "$filepath"
    log_success "Saved: $filepath"
    
    # æœ€æ–°ã®ãƒªãƒ³ã‚¯ã‚‚ä½œæˆï¼ˆå‚ç…§ã—ã‚„ã™ãã™ã‚‹ãŸã‚ï¼‰
    ln -sf "$(basename "$filepath")" "./tmp/latest-${role_lower}-report.md"
    log_info "Created link: ./tmp/latest-${role_lower}-report.md"
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’è¿”ã™
    echo "$filepath"
}

# å‰ã®å½¹å‰²ã®æˆæœç‰©ã‚’èª­ã¿è¾¼ã¿
load_previous_artifact() {
    local role="$1"
    local role_lower=$(echo "$role" | tr '[:upper:]' '[:lower:]')
    local filepath="./tmp/latest-${role_lower}-report.md"
    
    if [[ -f "$filepath" ]]; then
        log_info "Loading previous $role artifact..."
        bat --style=plain "$filepath"
    else
        log_warning "No previous $role artifact found"
        echo ""
    fi
}

# æœ€æ–°ã®æˆæœç‰©ãƒ‘ã‚¹ã‚’å–å¾—
get_latest_artifact_path() {
    local role="$1"
    local role_lower=$(echo "$role" | tr '[:upper:]' '[:lower:]')
    echo "./tmp/latest-${role_lower}-report.md"
}

# ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹è¡¨ç¤º
show_progress() {
    local current_step="$1"
    local total_steps="${2:-5}"
    local task_description="${3:-}"
    
    local progress=$((current_step * 100 / total_steps))
    local filled=$((progress / 10))
    local empty=$((10 - filled))
    
    echo ""
    echo -e "${CYAN}Task:${NC} $task_description"
    echo -n "Progress ["
    printf "%${filled}s" | tr ' ' '='
    printf "%${empty}s" | tr ' ' '-'
    echo "] ${progress}%"
    echo ""
}

# ã‚¿ã‚¹ã‚¯ã‚µãƒãƒªãƒ¼ã®ç”Ÿæˆ
generate_task_summary() {
    local task_description="$1"
    local timestamp=$(date +%Y%m%d-%H%M%S)
    local summary_path="./tmp/${timestamp}-task-summary.md"
    
    ensure_tmp_dir
    
    # ç”Ÿæˆã•ã‚ŒãŸæˆæœç‰©ã‚’ãƒªã‚¹ãƒˆ
    local artifacts=$(eza -la ./tmp/*-report.md 2>/dev/null | tail -10 || echo "No artifacts found")
    
    cat > "$summary_path" << EOF
# Task Summary

**Task**: $task_description  
**Date**: $(date)  
**Generated by**: Role Evolution Workflow

## Artifacts Generated

\`\`\`
$artifacts
\`\`\`

## Roles Executed

$(eza ./tmp/latest-*-report.md 2>/dev/null | while read -r file; do
    if [[ -f "$file" ]]; then
        role=$(basename "$file" | sed 's/latest-\(.*\)-report.md/\1/')
        echo "- âœ… ${role^}"
    fi
done || echo "- No roles executed yet")

## Next Steps

1. Review all reports in \`./tmp/\`
2. Commit changes if satisfied
3. Clean up old artifacts: \`cleanup_tmp 7\`

## Quick Access

- Explorer Report: \`./tmp/latest-explorer-report.md\`
- Analysis Report: \`./tmp/latest-analysis-report.md\`
- Design Document: \`./tmp/latest-design-report.md\`
- Implementation Log: \`./tmp/latest-implementation-report.md\`
- Review Report: \`./tmp/latest-review-report.md\`
EOF
    
    log_success "Task summary saved: $summary_path"
    
    # æœ€æ–°ã®ã‚µãƒãƒªãƒ¼ã¸ã®ãƒªãƒ³ã‚¯ã‚‚ä½œæˆ
    ln -sf "$(basename "$summary_path")" "./tmp/latest-task-summary.md"
}

# ./tmp/ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
cleanup_tmp() {
    local days_old="${1:-7}"
    
    log_info "Cleaning up files older than $days_old days in ./tmp/..."
    
    local count=0
    while IFS= read -r file; do
        if [[ -f "$file" ]]; then
            log_info "Removing: $file"
            rm -f "$file"
            ((count++))
        fi
    done < <(find ./tmp -name "*-report.md" -o -name "*-summary.md" -mtime +$days_old 2>/dev/null || true)
    
    if [[ $count -eq 0 ]]; then
        log_info "No old files found"
    else
        log_success "Cleaned up $count old files"
    fi
}

# å½¹å‰²ã®èª¬æ˜ã‚’è¡¨ç¤º
show_role_description() {
    local role="$1"
    
    case "$role" in
        "Explorer")
            echo "ğŸ” èª¿æŸ»ãƒ»æ¢ç´¢: æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ç†è§£ã€è¦ä»¶ã®æ˜ç¢ºåŒ–ã€åˆ¶ç´„ã®ç‰¹å®š"
            ;;
        "Analyst")
            echo "ğŸ“Š åˆ†æãƒ»è©•ä¾¡: å½±éŸ¿ç¯„å›²ã®åˆ†æã€ãƒªã‚¹ã‚¯è©•ä¾¡ã€å®Ÿè£…æˆ¦ç•¥ã®æ¤œè¨"
            ;;
        "Designer")
            echo "ğŸ¨ è¨­è¨ˆãƒ»è¨ˆç”»: ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©ã€ãƒ†ã‚¹ãƒˆæˆ¦ç•¥"
            ;;
        "Developer")
            echo "ğŸ’» å®Ÿè£…ãƒ»é–‹ç™º: ã‚³ãƒ¼ãƒ‰å®Ÿè£…ã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä½œæˆã€æ®µéšçš„ã‚³ãƒŸãƒƒãƒˆ"
            ;;
        "Reviewer")
            echo "âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å“è³ªç¢ºèª: ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™"
            ;;
        *)
            echo "â“ Unknown role: $role"
            ;;
    esac
}

# ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªå½¹å‰²é¸æŠ
select_next_role() {
    local current_role="${1:-}"
    
    echo ""
    log_info "Select next role:"
    echo "1) Explorer  - èª¿æŸ»ãƒ»æ¢ç´¢"
    echo "2) Analyst   - åˆ†æãƒ»è©•ä¾¡"
    echo "3) Designer  - è¨­è¨ˆãƒ»è¨ˆç”»"
    echo "4) Developer - å®Ÿè£…ãƒ»é–‹ç™º"
    echo "5) Reviewer  - ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ»å“è³ªç¢ºèª"
    echo "6) Exit      - çµ‚äº†"
    echo ""
    
    read -p "Choice (1-6): " choice
    
    case $choice in
        1) echo "Explorer" ;;
        2) echo "Analyst" ;;
        3) echo "Designer" ;;
        4) echo "Developer" ;;
        5) echo "Reviewer" ;;
        6) echo "Exit" ;;
        *) echo "Invalid" ;;
    esac
}

# ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
handle_error() {
    local exit_code=$1
    local error_msg=$2
    
    log_error "$error_msg (Exit code: $exit_code)"
    
    # ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’./tmp/ã«ä¿å­˜
    local timestamp=$(date +%Y%m%d-%H%M%S)
    local error_report="./tmp/${timestamp}-error-report.md"
    
    ensure_tmp_dir
    cat > "$error_report" << EOF
# Error Report

**Time**: $(date)  
**Exit Code**: $exit_code  
**Error**: $error_msg  
**Current Role**: ${CURRENT_ROLE:-Unknown}

## Stack Trace
$(caller)

## Suggestions
- Check the error message above
- Review recent changes
- Run with debug mode: \`bash -x\`
EOF
    
    log_error "Error report saved: $error_report"
    
    # ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ã§ãªã‘ã‚Œã°çµ‚äº†
    if [[ "${TEST_MODE:-false}" != "true" ]]; then
        exit "$exit_code"
    fi
}

# ç’°å¢ƒæ¤œè¨¼ï¼ˆç°¡ç´ åŒ–ç‰ˆï¼‰
verify_environment() {
    log_info "Verifying environment..."
    
    # Gitç¢ºèª
    if ! command -v git &> /dev/null; then
        handle_error 1 "Git is not installed"
    fi
    
    # ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒgitãƒªãƒã‚¸ãƒˆãƒªã‹ç¢ºèª
    if ! git rev-parse --is-inside-work-tree &> /dev/null; then
        handle_error 1 "Not inside a git repository"
    fi
    
    log_success "Environment verification passed"
}

# ä½¿ç”¨çµ±è¨ˆã®è¡¨ç¤º
show_statistics() {
    ensure_tmp_dir
    
    echo ""
    echo "ğŸ“Š Workflow Statistics"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # å„å½¹å‰²ã®æˆæœç‰©æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    for role in explorer analyst designer developer reviewer; do
        local count=$(eza ./tmp/*-${role}-report.md 2>/dev/null | wc -l || echo "0")
        printf "%-12s: %3d artifacts\n" "${role^}" "$count"
    done
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # åˆè¨ˆã‚µã‚¤ã‚º
    local total_size=$(du -sh ./tmp 2>/dev/null | cut -f1 || echo "0")
    echo "Total size: $total_size"
}

# ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
export -f log_info log_success log_warning log_error log_role
export -f ensure_tmp_dir switch_role save_artifact load_previous_artifact
export -f get_latest_artifact_path show_progress generate_task_summary
export -f cleanup_tmp show_role_description select_next_role
export -f handle_error verify_environment show_statistics
export CURRENT_ROLE

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    echo "role-utils.sh - Role Evolution Workflow Utilities"
    echo ""
    echo "This script provides utilities for the role-based workflow."
    echo "It should be sourced in other scripts:"
    echo ""
    echo "  source .klaude/scripts/role-utils.sh"
    echo ""
    echo "Available functions:"
    echo "  - switch_role <role> [description]"
    echo "  - save_artifact <role> <content>"
    echo "  - load_previous_artifact <role>"
    echo "  - show_progress <current> <total> [task]"
    echo "  - generate_task_summary <task_description>"
    echo "  - cleanup_tmp [days_old]"
    echo "  - show_statistics"
    echo ""
fi