# Plan Results: multi-feature.mdのセッション分離問題修正

## 計画日時
2025-06-25

## 実装戦略

### 1. 修正アプローチ
multi-tdd.mdで実装した修正パターンをmulti-feature.mdに適用します。これにより、コードベースの一貫性を保ち、保守性を向上させます。

### 2. 実装段階

#### Phase 1: Step 1の修正
1. 環境ファイル名生成ロジックの追加
2. 環境変数を`.worktrees/.env-{task-id}`に保存する処理の追加
3. 環境ファイルパスの表示を追加

#### Phase 2: 各フェーズの修正（Phase 1-4 + Step 3）
各フェーズの開始時に以下を追加：
1. worktree-utils.shの再読み込み
2. 環境ファイルの検索と読み込み
3. 環境変数の復元確認

#### Phase 3: クリーンアップ処理の修正
1. worktree削除時に環境ファイルも削除
2. 手動削除用のコマンドに環境ファイル削除を追加

### 3. テスト戦略

#### 単体テスト
- 各フェーズで関数が利用可能かを確認
- 環境変数が正しく復元されているかを確認

#### 統合テスト
- multi-feature.mdを使用して簡単なタスクを実行
- 全フェーズが正常に動作することを確認

### 4. リスク軽減策

#### 並行実行の問題
- 現在の実装では`ls -t`で最新ファイルを取得しているため、並行実行時に問題が生じる可能性
- 将来的な改善として、Step 1で生成したENV_FILEパスを各フェーズに明示的に渡す方式を検討

#### エラーハンドリング
- 環境ファイルが見つからない場合の明確なエラーメッセージ
- 各フェーズでの失敗時にも環境ファイルをクリーンアップ

### 5. 実装の優先順位

1. **最優先**: Step 1への環境保存機能追加
2. **高優先**: Phase 1-4の開始部分への環境復元処理追加
3. **高優先**: Step 3（完了通知）への環境復元処理追加
4. **中優先**: クリーンアップ処理の改善

### 6. 品質基準

- すべてのフェーズで関数と環境変数が利用可能
- エラー時の適切なメッセージ表示
- 環境ファイルの適切なクリーンアップ
- multi-tdd.mdとの実装の一貫性

### 7. 実装に必要な変更箇所

1. **Line 23-57**: Step 1のbashブロック
   - 環境ファイル生成と保存処理を追加

2. **Line 66-74**: Phase 1の開始部分
   - worktree-utils.shと環境ファイルの読み込みを追加

3. **Line 117-122**: Phase 2の開始部分
   - 同上

4. **Line 161-163**: Phase 3の開始部分
   - 同上

5. **Line 189-194**: Phase 4の開始部分
   - 同上

6. **Line 262-263**: Step 3の開始部分
   - 同上

7. **Line 393-403**: クリーンアップ処理
   - 環境ファイル削除を追加

## 次のステップ

1. 上記の変更を実装
2. 変更内容の検証
3. テストの実行
4. ドキュメントの更新（必要に応じて）