# 修正フェーズ3: 検証とテスト - 実行計画

## 計画策定日時
2025-06-24

## 段階的実行計画

### Stage 1: 環境準備と事前確認（10分）
1. **parallel-agent-utils.sh問題の修正**
   - ファイル存在確認
   - worktree-utils.shの読み込み部分修正
   - 依存関係の解決

2. **テスト環境の準備**
   - 一時的なテストディレクトリ作成
   - 必要なファイルのコピー
   - 権限設定の確認

### Stage 2: 単体テストの実行（15分）
1. **test-refactor-fixes.sh実行**
   - 全テストケースの実行
   - 結果の記録とログ保存
   - 失敗ケースの分析

2. **追加テストケース作成**
   - エッジケースの追加
   - 境界値テスト
   - 異常系テスト

### Stage 3: 統合テストの実施（30分）
1. **実際のmulti-refactorコマンド実行**
   ```bash
   # テスト1: 日本語パラメータ
   /multi-refactor "認証機能のJWT有効期限チェック不具合を修正" --keep-worktree
   
   # テスト2: 英語パラメータ
   /multi-refactor "fix auth JWT expiry check issue" --keep-worktree
   
   # テスト3: 複雑な日本語
   /multi-refactor "データベース接続プールの最適化とエラーハンドリング改善" --keep-worktree
   ```

2. **フェーズ順次実行の確認**
   - 各フェーズの開始・終了確認
   - フェーズ間のデータ受け渡し確認
   - ステータスファイルの生成確認

### Stage 4: エラーシナリオテスト（20分）
1. **意図的なエラー発生**
   - ファイル書き込み権限エラー
   - Git操作エラー
   - ネットワークエラー（該当する場合）

2. **ロールバック動作確認**
   - エラーレポート生成
   - worktree状態の確認
   - 復旧手順の実行

### Stage 5: パフォーマンステスト（15分）
1. **実行時間の測定**
   - 各フェーズの実行時間
   - 全体の処理時間
   - ボトルネックの特定

2. **リソース使用量確認**
   - メモリ使用量
   - ディスク使用量
   - プロセス数

## テスト戦略

### 成功基準
- ✅ 全単体テストがパス
- ✅ 日本語・英語両方のパラメータで正常動作
- ✅ エラー時の適切なロールバック
- ✅ フェーズ管理システムの正常動作
- ✅ 既存機能への影響なし

### ロールバック計画
1. **Stage毎のチェックポイント**
   - 各Stage完了時に状態確認
   - 問題発生時は前のStageに戻る

2. **緊急時の対応**
   - worktree-utils.shのバックアップから復元
   - multi-refactor.mdの以前のバージョンに戻す
   - gitでの変更履歴から復元

### リスク軽減策
1. **バックアップ作成**
   ```bash
   cp .claude/scripts/worktree-utils.sh .claude/scripts/worktree-utils.sh.bak
   cp .claude/commands/multi-refactor.md .claude/commands/multi-refactor.md.bak
   ```

2. **段階的テスト**
   - 小さな変更から開始
   - 各段階で動作確認
   - 問題の早期発見

## 検証項目チェックリスト

### 必須検証項目
- [ ] parallel-agent-utils.sh読み込みエラーの解決
- [ ] 日本語パラメータでのブランチ名生成
- [ ] 変数名統一の動作確認
- [ ] フェーズ管理システムの動作
- [ ] エラーハンドリングとロールバック

### 推奨検証項目
- [ ] パフォーマンスの改善確認
- [ ] ログ出力の適切性
- [ ] ドキュメントとの整合性
- [ ] 他のmulti-*コマンドへの影響確認

## 次のステップ
1. 本計画に基づいた検証実施
2. 検証結果のレポート作成
3. 問題点の修正
4. ドキュメントの更新
5. 最終確認とマージ準備