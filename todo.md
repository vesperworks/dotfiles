# TODO: マルチエージェントワークフロー実装の残タスク

更新日: 2025-06-24（完了タスクをdone.mdへ移動）

## 🔴 未実装項目（CLAUDE.md記載内容との差分）

### Scripts整備
- [ ] CLAUDE.mdのプロジェクト構造に記載なし → CLAUDE.mdの更新が必要

### 各ワークフローの自動テストスクリプト作成
- [ ] 各ワークフローの自動テストスクリプト作成

### TDDサイクルの並列化による効率化（将来拡張）
- [ ] Testerエージェントの早期投入
  - [ ] 各TDDサイクル完了後に即座にTesterを起動
  - [ ] Coderの次サイクルとTesterの検証を並列実行
- [ ] MCP連携の専門化
  - [ ] MCP-Testerサブエージェント（Playwright/Puppeteer専門）
  - [ ] E2Eテストの自動生成・実行を並列化
- [ ] 効果測定（運用後実施予定）
  - [ ] TDDサイクル時間の短縮率を計測（目標：30-40%短縮）
  - [ ] 早期品質問題発見率の向上

### 並列TDD機能のコマンド統合
- [ ] multi-tdd.mdに`--parallel`オプションを追加
- [ ] オプション指定時に`run_parallel_agents()`を呼び出す
- [ ] デフォルトは従来の順次実行を維持
- [ ] 使用例とパフォーマンス比較をドキュメント化

### MCP連携機能の実装
- [ ] Context7連携の具体的な実装
- [ ] Playwright/Puppeteer統合のサンプル作成
- [ ] MCP設定ドキュメントの作成

## 🔧 修正フェーズ2: 機能修正（実施中）

### 変数スコープとエラーハンドリングバグ（中優先度）
- [ ] **Problem**: 変数の初期化とエラー処理が不完全
  - [ ] **新たな発見**: `$ARGUMENTS` と `$TASK_DESCRIPTION` の変数名不一致問題
  - [ ] multi-refactor.mdで`$ARGUMENTS`使用、worktree-utils.shで`$TASK_DESCRIPTION`に変換
  - [ ] タスクID生成時の文字列処理エラー（日本語文字列対応不備）
  - [ ] ブランチ名が空文字列になり `fatal: '' is not a valid branch name` エラー
- [ ] **Solution**: 変数管理とパラメータ処理の修正
  - [ ] **Step 1**: 変数名を統一（`$ARGUMENTS` vs `$TASK_DESCRIPTION`）
  - [ ] **Step 2**: multi-refactor.md全体で一貫性のある変数使用に修正
  - [ ] **Step 3**: 日本語文字列処理の改善（sedコマンド修正、UTF-8対応）
  - [ ] **Step 4**: ブランチ名生成の堅牢化（デフォルト値設定、特殊文字除去）
  - [ ] **Step 5**: エラーケースの網羅的テスト（空文字列、特殊文字、長い文字列）

### Phase間の依存関係管理バグ（中優先度）
- [ ] **Problem**: 各フェーズ間の依存関係と状態管理が未実装
  - [ ] Analysis -> Plan -> Refactor -> Verify の順序制御なし
  - [ ] 前フェーズの失敗時の処理が不明確
  - [ ] 並行実行との競合状態の可能性
  - [ ] ファイル作成確認の条件分岐が機能しない
- [ ] **Solution**: フェーズ管理システムの実装
  - [ ] **Step 1**: フェーズ状態管理システムの設計（.status ファイル利用）
  - [ ] **Step 2**: 前フェーズ完了確認の実装（ファイル存在チェック強化）
  - [ ] **Step 3**: エラー時のロールバック機能追加（worktree削除、状態リセット）
  - [ ] **Step 4**: フェーズ間データ受け渡しの標準化（JSON形式の採用）
  - [ ] **Step 5**: 並行実行との競合回避機能（ロックファイル機構）

## 📝 修正フェーズ3: 検証とテスト（次のステップ）

### 修正完了の検証手順
- [ ] **テスト1**: 日本語パラメータでのworktree作成テスト
- [ ] **テスト2**: 各フェーズの順次実行テスト（Analysis→Plan→Refactor→Verify）
- [ ] **テスト3**: エラー発生時の適切な処理テスト（rollback動作確認）
- [ ] **テスト4**: 最終的なリファクタリング完了テスト（実際のコード整理）

## 🟡 推奨改善項目

### ドキュメント整備
- [ ] トラブルシューティングガイド
- [ ] ベストプラクティス集

### エラーハンドリング強化
- [ ] worktree作成失敗時のリトライ機能
- [ ] ネットワークエラー時の対処
- [ ] 不完全なタスクのリカバリー機能

### 監視・ログ機能
- [ ] タスク実行履歴の記録
- [ ] パフォーマンスメトリクスの収集
- [ ] 成功/失敗率の可視化

### 設定のカスタマイズ
- [ ] `.claude/config.json` - ユーザー設定ファイル
- [ ] タイムアウト値の調整機能
- [ ] デフォルトブランチ名のカスタマイズ

## 📅 優先順位

### 🔄 進行中タスク
1. **高**: 変数スコープとエラーハンドリングバグの修正
2. **高**: Phase間の依存関係管理バグの修正

### 📈 今後の優先順位
1. **高**: 並列TDD機能のコマンド統合（ユーザーが使える状態にする）
2. **中**: 各ワークフローの自動テストスクリプト作成
3. **低**: MCP連携機能の実装（別フェーズでも可）
4. **低**: 推奨改善項目（運用開始後に順次対応）

## 💡 次のアクション

### 🔧 実施予定項目
1. **変数名統一の修正** - `$ARGUMENTS`と`$TASK_DESCRIPTION`の一貫性確保
2. **日本語パラメータ処理の修正** - 文字列処理とブランチ名生成修正
3. **フェーズ管理システムの実装** - 状態管理とエラーハンドリング

### 🎯 従来の次のアクション
1. **並列TDD機能のコマンド統合** - multi-tdd.mdに`--parallel`オプションを追加
2. 各ワークフローの自動テストスクリプト作成
3. MCP連携機能の実装検討
4. エラーハンドリング強化（リトライ機能など）

## 🛠️ multi-refactorバグ修正の詳細実装手順

### 🔧 修正フェーズ2: 機能修正（実施中）  
1. **変数処理修正** - `$ARGUMENTS`と`$TASK_DESCRIPTION`の統一が必要
2. **フェーズ管理修正** - 状態管理システムとエラーハンドリングの実装

### 📝 修正フェーズ3: 検証とテスト（予定）
1. **統合テスト** - 修正後の動作確認とエラーケーステスト
2. **ドキュメント更新** - 修正内容の反映と使用方法の更新

## 🚨 緊急次のアクション（multi-refactorバグ修正）

### 🔧 実施予定項目
1. **変数名統一の修正** - `$ARGUMENTS`と`$TASK_DESCRIPTION`の一貫性確保
2. **日本語パラメータ処理の修正** - 文字列処理とブランチ名生成修正
3. **フェーズ管理システムの実装** - 状態管理とエラーハンドリング

## 🔧 期待される効果
- **モジュール化**: 並列実行機能の独立管理
- **再利用性**: 他プロジェクトでの活用可能
- **保守性**: 機能別の責任分離により修正が容易
- **拡張性**: 新しいエージェントタイプの追加が容易

## 🌟 multi-feature.md改善項目（Anthropicプロンプト分析から）

### 高優先度改善
- [ ] **XMLタグ構造の導入**
  - [ ] `<feature_development_workflow>`でワークフロー全体を囲む
  - [ ] 各フェーズを`<phase name="explore">`等でマークアップ
  - [ ] `<objectives>`, `<tools>`, `<output>`で各フェーズ内容を構造化
  - [ ] `<quality_gates>`で品質基準を明確化

- [ ] **強調語の体系的使用**
  - [ ] `ALWAYS`: 必須のコミット、テスト実行に使用
  - [ ] `NEVER`: 未テストのコミット、main直接編集の禁止に使用
  - [ ] `MUST`: ファイル作成前の確認、品質ゲート通過に使用
  - [ ] `IMPORTANT`: 重要な注意事項に限定使用

### 中優先度改善
- [ ] **番号付きリストによる段階的指示**
  - [ ] 各フェーズ内のステップを番号付きリストに変更
  - [ ] サブステップは箇条書きで整理
  - [ ] ステップ名をボールド体で強調

- [ ] **具体例の追加**
  - [ ] 各ワークフローに実行例を3つ以上追加
  - [ ] feature開発の具体例（認証、決済、通知など）
  - [ ] 期待される成果物の例を明示

- [ ] **数値制限の明示**
  - [ ] 最大ファイル数/フェーズ: 10
  - [ ] 最大コミット数/フェーズ: 5
  - [ ] タイムアウト/フェーズ: 15分
  - [ ] 最小テストカバレッジ: 80%

### 低優先度改善
- [ ] **簡潔性の向上**
  - [ ] 冗長な説明を削除
  - [ ] コマンド例をコードブロックで簡潔に
  - [ ] 「情報密度を高く、言葉数は最小に」の原則適用

- [ ] **条件分岐の明示的処理**
  - [ ] 「For depth-first features:」形式で条件別対応を記載
  - [ ] 「For breadth-first features:」で並列開発可能な機能を区別
  - [ ] 「For straightforward features:」で単純な機能開発を効率化

- [ ] **エラーハンドリングとフォールバック**
  - [ ] 各フェーズのエラー時の具体的対処法
  - [ ] 競合解決のための手順
  - [ ] ロールバック手順の明確化

### 実装順序
1. **第1段階**: XMLタグ構造と強調語の導入（構造的改善）
2. **第2段階**: 番号付きリストと具体例の追加（理解促進）
3. **第3段階**: 数値制限と品質ゲートの明示（品質保証）
4. **第4段階**: 簡潔性向上と条件分岐処理（最適化）